<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gladimir IoT Panel</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Paho MQTT -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/mqttws31.min.js"></script>

  <style>
    :root {
      --bg-color: #000;
      --text-color: #33ff33;
      --link-color: #3399ff;
      --dir-color: #ff66ff;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: monospace;
      font-size: 1.1em;
      padding: 20px;
    }

    .mqtt-section {
      margin-top: 30px;
      border-top: 1px dashed var(--text-color);
      padding-top: 20px;
    }

    .mqtt-buttons button {
      margin-right: 10px;
      padding: 5px 10px;
      font-size: 1em;
      cursor: pointer;
    }

    .mqtt-values {
      margin-top: 15px;
      font-size: 1.2em;
    }

    .mqtt-values span {
      font-weight: bold;
      color: var(--dir-color);
    }

    .status {
      color: yellow;
      font-weight: bold;
    }

    canvas {
      max-width: 100%;
      background-color: #111;
      border: 1px solid #444;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Gladimir ‚Äì ESP32 + MQTT</h1>

  <div class="mqtt-section">
    <h3>Conex√£o MQTT (HiveMQ)</h3>
    <pre id="mosquittoLog" class="status">üïê Aguardando conex√£o...</pre>

    <div class="mqtt-buttons">
      <button onclick="enviarComando('Gladimir/led', 'liga')">Ligar Luz</button>
      <button onclick="enviarComando('Gladimir/led', 'desliga')">Desligar Luz</button>
    </div>

    <div class="mqtt-values">
      <p>üå°Ô∏è Temperatura: <span id="tempValue">--</span> ¬∞C</p>
      <p>üíß Umidade: <span id="umidValue">--</span> %</p>
    </div>

    <h3>üìä Gr√°ficos</h3>
    <canvas id="chartTemp" height="150"></canvas>
    <canvas id="chartUmid" height="150"></canvas>
  </div>

  <script>
    const mqttLog = document.getElementById("mosquittoLog");
    const tempSpan = document.getElementById("tempValue");
    const umidSpan = document.getElementById("umidValue");

    // Chart.js - Temperatura
    const ctxTemp = document.getElementById("chartTemp").getContext("2d");
    const chartTemp = new Chart(ctxTemp, {
      type: "line",
      data: { labels: [], datasets: [{ label: "Temperatura (¬∞C)", data: [], borderColor: "#ff6666", backgroundColor: "rgba(255, 100, 100, 0.2)", tension: 0.2 }] },
      options: {
        scales: {
          x: { ticks: { color: '#ccc' }, grid: { color: '#333' } },
          y: { ticks: { color: '#ccc' }, grid: { color: '#333' } }
        },
        plugins: { legend: { labels: { color: '#ccc' } } }
      }
    });

    // Chart.js - Umidade
    const ctxUmid = document.getElementById("chartUmid").getContext("2d");
    const chartUmid = new Chart(ctxUmid, {
      type: "line",
      data: { labels: [], datasets: [{ label: "Umidade (%)", data: [], borderColor: "#66ccff", backgroundColor: "rgba(100, 200, 255, 0.2)", tension: 0.2 }] },
      options: {
        scales: {
          x: { ticks: { color: '#ccc' }, grid: { color: '#333' } },
          y: { ticks: { color: '#ccc' }, grid: { color: '#333' } }
        },
        plugins: { legend: { labels: { color: '#ccc' } } }
      }
    });

    // Conex√£o com HiveMQ Cloud (Serverless)
    const clientID = "mqttjs_" + Math.random().toString(16).substr(2, 8);

    const mqttClient = new Paho.MQTT.Client(
      "8b636f536c81441b8d1e3bb0ad8e95ff.s1.eu.hivemq.cloud",
      8884,
      "/mqtt",
      clientID
    );

    mqttClient.onConnectionLost = () => {
      mqttLog.textContent += "\nüîå Conex√£o perdida.";
      mqttLog.classList.add("status");
    };

    mqttClient.onMessageArrived = function (message) {
      const topico = message.destinationName;
      const valor = message.payloadString;
      mqttLog.textContent += `\n[${topico}] ${valor}`;

      const hora = new Date().toLocaleTimeString();

      if (topico === "Gladimir/temp") {
        tempSpan.textContent = valor;
        atualizarGrafico(chartTemp, hora, parseFloat(valor));
      } else if (topico === "Gladimir/umid") {
        umidSpan.textContent = valor;
        atualizarGrafico(chartUmid, hora, parseFloat(valor));
      }
    };

    mqttClient.connect({
      useSSL: true,
      userName: "gladimir",
      password: "F3licidade",
      onSuccess: () => {
        mqttLog.textContent = "‚úÖ Conectado ao HiveMQ Cloud via WSS";
        mqttLog.classList.remove("status");
        mqttClient.subscribe("Gladimir/#");
      },
      onFailure: (err) => {
        mqttLog.textContent = "‚ùå Falha: " + err.errorMessage;
        mqttLog.classList.add("status");
      }
    });

    function enviarComando(topico, mensagem) {
      const msg = new Paho.MQTT.Message(mensagem);
      msg.destinationName = topico;
      mqttClient.send(msg);
      mqttLog.textContent += `\nüì§ Enviado: [${topico}] ${mensagem}`;
    }

    function atualizarGrafico(chart, label, valor) {
      if (chart.data.labels.length > 30) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }
      chart.data.labels.push(label);
      chart.data.datasets[0].data.push(valor);
      chart.update();
    }
  </script>
</body>
</html>
